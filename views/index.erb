<nav class="navbar navbar-default" role="navigation">
  <div class="navbar-header">
    <div class="navbar-brand">Ruby Tapas</a>
  </div>
  <ul class="nav navbar-nav">
    <li <%= all_eps? ? 'class="active"' : '' %>><a href="/all">All</a></li>
    <li <%= all_eps? ? '' : 'class="active"' %>><a href="/unwatched">Unwatched</a></li>
  </ul>
</nav>

<div class="container">
  <table id="episode-list" class="table table-striped">
    <thead>
      <th class="ep-number">Number</th>
      <th>Title</th>
      <th class="ep-description">Description</th>
      <th class="ep-actions">Actions</th>
    </thead>
    <tbody>
      <% episodes.each do |ep| %>
        <tr>
          <td><%= ep.number %></td>
          <td><%= ep.title %></td>
          <td><%= ep.description %></td>
          <td>
            <% if ep.has_video? %>
              <form action="<%= mark_as_watched_path ep %>" method=post>
                <% unless ep.watched? %>
                  <button type="submit" class="btn btn-default">
                    Mark watched
                  </button>
                  <br/>
                  <br/>
                <% end %>
                <button type="submit" class="btn btn-success" name="redirect_to" value="<%= ep.local_video_url %>">
                  Watch episode
                </button>
              </form>
            <% else %>
              <form action="<%= download_path ep %>" method=post>
                <button type="submit" class="btn btn-primary">Download</button>
              </form>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>


<script>
function monitorProgress(form, url, percent) {
  var num = parseInt(percent * 100)
  $(form).find('button').first().text("Downloading: " + num + "%")
  if (num < 100) setTimeout(function(){
    $.get(url, function(newPercent){
      monitorProgress(form, url, parseFloat(newPercent))
    })
  }, 2000)
}

$(document).on('submit', 'form[action^="/download"]', function(){
  var form = $(this)
  form.find('button').attr('disabled', true)
  $.post(form.attr('action'), function(progressUrl){
    monitorProgress(form, progressUrl, 0)
  })
  return false
})



$(document).ready(function(){
    $('#episode-list').dataTable(
      {
        "order": [0, "desc"],
        "columnDefs": [
        {
           "targets": "ep-number",
           "type": "num"
         },
         {
            "targets": "ep-description",
            "width": "600px"
         },
         {
            "targets": "ep-actions",
            "searchable": false,
            "orderable": false
         }]}
      );
});
</script>
